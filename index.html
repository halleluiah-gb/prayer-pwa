<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="theme-color" content="#0d6efd" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  
  <!-- Enhanced PWA Meta Tags for Camera -->
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-title" content="Halleluiah">
  <meta name="application-name" content="Halleluiah">
  <meta name="msapplication-TileColor" content="#0d6efd">
  <meta name="msapplication-tap-highlight" content="no">
  
  <!-- Camera Permissions Meta -->
  <meta name="camera" content="allow">
  <meta name="microphone" content="deny">
  
  <link rel="manifest" href="/manifest.json" />
  <link rel="apple-touch-icon" href="/icon-192.png" />
  <link rel="icon" href="/icon-192.png" />
  <title>Prayer Tracker - Halleluiah</title>

<!-- Firebase App (Core SDK) -->
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-messaging-compat.js"></script>

<script>
  // Your Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyCIrp6XdejjP2SX6C2YNWl54HD99hgDZpY",
    authDomain: "halleluiah-efd3d.firebaseapp.com",
    projectId: "halleluiah-efd3d",
    storageBucket: "halleluiah-efd3d.appspot.com",
    messagingSenderId: "1000881270210",
    appId: "1:1000881270210:web:687252e435b9ef86ddba5b",
    measurementId: "G-5K2160S951"
  };

  // Initialize Firebase
  firebase.initializeApp(firebaseConfig);

  const messaging = firebase.messaging();

  // Request notification permission
  async function requestPermission() {
    try {
      const token = await messaging.getToken({
        vapidKey: "BOFxB2fLiAEGSzpcRGkHtoYusJxRV8mNm98DngS0cOTNkAkus1mNV8URJz-4CndNM0MFX2SvVbcfg5ehI9Mv8VA"
      });
      if (token) {
      console.log("‚úÖ FCM Token:", token);
    } else {
      console.warn("‚ö†Ô∏è No registration token available. Request permission to generate one.");
    }
    } catch (err) {
      console.error("Permission denied or error:", err);
    }
  }

  requestPermission();

  // Handle foreground messages
  messaging.onMessage((payload) => {
    console.log("Message received: ", payload);
    alert(payload.notification.title + ": " + payload.notification.body);
  });
</script>

  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      width: 100%;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: white;
      -webkit-tap-highlight-color: transparent;
    }
    #banner {
      height: 40px;
      line-height: 40px;
      text-align: center;
      font-weight: bold;
      font-size: 1rem;
      color: white;
      background: #0d6efd;
      -webkit-user-select: none;
      user-select: none;
    }
    #offlineBanner {
      display: none;
      background: #dc3545;
      color: white;
      text-align: center;
      padding: 0.5rem;
      font-weight: bold;
    }
    #welcome {
      padding: 1.5rem;
      text-align: center;
      height: calc(100% - 40px);
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }
    #installBtn {
      margin-top: 1.5rem;
      padding: 0.8rem 1.5rem;
      font-size: 1rem;
      background: #0d6efd;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.3s;
    }
    #installBtn:hover {
      background: #0b5ed7;
    }
    #appFrame {
      height: calc(100% - 40px);
      width: 100%;
      overflow: hidden;
      display: none;
      position: relative;
    }
    iframe {
      border: none;
      height: 100%;
      width: 100%;
      display: block;
    }
    #loadingOverlay {
      position: absolute;
      inset: 0;
      background: rgba(255, 255, 255, 0.95);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
      font-weight: bold;
      color: #0d6efd;
      z-index: 10;
    }
    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #0d6efd;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin-bottom: 1rem;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    a {
      color: #0d6efd;
      text-decoration: none;
    }
    #installHelp {
      display: none;
      color: gray;
      margin-top: 1rem;
      text-align: center;
      max-width: 300px;
    }

    /* Chrome Recommendation Banner */
    .chrome-banner {
      background: #fff3cd;
      border: 1px solid #ffeeba;
      color: #856404;
      padding: 1rem;
      max-width: 500px;
      margin: 1rem auto;
      border-radius: 8px;
      font-size: 0.9rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      transform: translateY(-150%);
      opacity: 0;
      animation: slideDown 0.6s ease forwards;
    }
    @keyframes slideDown {
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    /* Camera Permission Helper */
    .camera-help {
      background: #d1ecf1;
      border: 1px solid #bee5eb;
      color: #0c5460;
      padding: 1rem;
      border-radius: 8px;
      margin: 1rem 0;
      max-width: 500px;
    }
    .camera-help h4 {
      margin: 0 0 0.5rem 0;
      color: #0c5460;
    }
    .camera-help ul {
      text-align: left;
      margin: 0.5rem 0;
      padding-left: 1.5rem;
    }
    .camera-help li {
      margin: 0.25rem 0;
    }
  </style>
</head>
<body>
  <noscript>Your browser does not support JavaScript. This app requires JavaScript to run.</noscript>

  <div id="banner">üôè Halleluiah</div>
  <div id="offlineBanner">‚ùå You are currently offline</div>

  <div id="welcome">
    <h1>Welcome to Halleluiah Prayer Tracker</h1>
    <p>Track daily prayer minutes for yourself or your family. Log prayers, record reflections, and view progress over time.</p>
    <p><strong>Who is it for?</strong><br>Individuals, families, and small prayer groups.</p>

    <!-- Camera Help Section -->
    <div class="camera-help">
      <h4>üì∏ Camera Access Note</h4>
      <p>This app includes bill capture features. For best camera performance:</p>
      <ul>
        <li>‚úÖ Install as PWA (recommended)</li>
        <li>‚úÖ Use Chrome or Safari</li>
        <li>‚úÖ Allow camera permissions when prompted</li>
        <li>‚úÖ Ensure good lighting for bill photos</li>
      </ul>
    </div>

    <p>
      <a href="/privacy" target="_blank">Privacy Policy</a> |
      <a href="/terms-of-service" target="_blank">Terms</a>
    </p>

    <button id="installBtn">üì≤ Install App</button>
    <p id="openInChromeContainer" style="display:none; margin-top:1rem;">
      <a id="openInChromeLink"
        href="intent://script.google.com/macros/s/AKfycbwp0od-C3Pun0Mj7b1a_DnX6DpQTg7fNKG1vx8eZwou7r2h2maV23lzOGLV5d5iuIgE/exec#Intent;scheme=https;package=com.android.chrome;end"
        style="color: #0d6efd; font-weight: bold;">
        üåê Open in Chrome
      </a>
    </p>

    <small>If you don't see the install prompt, open the browser menu and select <b>"Add to Home Screen"</b>.</small>
    <small id="installHelp">If you don't see the install button, open the browser menu and choose <b>"Add to Home Screen"</b> manually.</small>
  </div>

  <div id="appFrame">
    <div id="loadingOverlay">
      <div class="spinner"></div>
      <div>Loading Prayer Tracker...</div>
      <small style="margin-top: 1rem; color: #666;">Compete with all CREATION in Praising the LORD</small>
    </div>
    <iframe id="appIframe" src="" loading="eager" allow="camera; fullscreen"></iframe>
  </div>

<script>
  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwp0od-C3Pun0Mj7b1a_DnX6DpQTg7fNKG1vx8eZwou7r2h2maV23lzOGLV5d5iuIgE/exec";
  const isStandalone = window.matchMedia('(display-mode: standalone)').matches || navigator.standalone;
  let deferredPrompt = null;

  function isAndroid() {
    return /android/i.test(navigator.userAgent);
  }
  
  function isIOS() {
    return /iphone|ipad|ipod/i.test(navigator.userAgent);
  }
  
  function isChrome() {
    return /chrome/i.test(navigator.userAgent) && !/edg/i.test(navigator.userAgent) && !/firefox/i.test(navigator.userAgent);
  }

  function isSecureContext() {
    return window.isSecureContext || 
           window.location.protocol === 'https:' || 
           window.location.hostname === 'localhost' ||
           window.location.hostname === '127.0.0.1';
  }

  // Check camera support
  function checkCameraSupport() {
    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
      console.warn('Camera API not supported');
      return false;
    }
    
    if (!isSecureContext()) {
      console.warn('Camera requires secure context');
      return false;
    }
    
    return true;
  }

  const updateOnlineStatus = () => {
    const online = navigator.onLine;
    document.getElementById('offlineBanner').style.display = online ? 'none' : 'block';
    document.getElementById('banner').style.background = online ? '#0d6efd' : '#dc3545';
  };
  
  window.addEventListener('online', updateOnlineStatus);
  window.addEventListener('offline', updateOnlineStatus);

  document.addEventListener('DOMContentLoaded', () => {
    updateOnlineStatus();

    // Show camera support status
    const cameraSupported = checkCameraSupport();
    console.log('Camera supported:', cameraSupported);
    
    if (!cameraSupported && isSecureContext()) {
      const cameraNote = document.createElement('div');
      cameraNote.className = 'camera-help';
      cameraNote.innerHTML = `
        <h4>‚ö†Ô∏è Camera Note</h4>
        <p>Camera features may not work in this browser. For best results:</p>
        <ul>
          <li>Install the PWA version</li>
          <li>Use Chrome or Safari</li>
          <li>Ensure HTTPS connection</li>
        </ul>
      `;
      document.getElementById('welcome').querySelector('.camera-help').after(cameraNote);
    }

    // Show Chrome recommendation if Android but not Chrome
    if (isAndroid() && !isChrome()) {
      const chromeMsg = document.createElement('div');
      chromeMsg.className = 'chrome-banner';
      chromeMsg.innerHTML = `
        <strong>üì¢ Best viewed in Chrome</strong><br>
        <a href="intent://script.google.com/macros/s/AKfycbwp0od-C3Pun0Mj7b1a_DnX6DpQTg7fNKG1vx8eZwou7r2h2maV23lzOGLV5d5iuIgE/exec#Intent;scheme=https;package=com.android.chrome;end" style="color:#0d6efd;text-decoration:underline;">üëâ Open in Chrome</a><br><br>
        <small><b>To set Chrome as default:</b><br>
        1. Open <i>Settings</i> ‚Üí <i>Apps</i> ‚Üí <i>Default apps</i>.<br>
        2. Tap <i>Browser app</i>.<br>
        3. Select <i>Chrome</i>.</small>
      `;
      document.getElementById('welcome').prepend(chromeMsg);
    }

    // Skip welcome if installed or returning user
    const hasStoredUser = localStorage.getItem("storedUserEmail");
    if (isStandalone || hasStoredUser) {
      document.getElementById("welcome").style.display = "none";
      const appFrame = document.getElementById("appFrame");
      appFrame.style.display = "block";
      const iframe = document.getElementById("appIframe");
      iframe.src = SCRIPT_URL;
      iframe.onload = () => {
        document.getElementById("loadingOverlay").style.display = "none";
        console.log('App loaded in PWA mode');
      };
    }

    // Install prompt handling
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      document.getElementById("installBtn").style.display = "inline-block";
      
      // Show enhanced install message
      document.querySelector('#installHelp').innerHTML = `
        <strong>üí° For best camera performance:</strong><br>
        Install this app to your home screen. Camera features work best in installed PWA mode.
      `;
      document.getElementById("installHelp").style.display = "block";
    });

    document.getElementById("installBtn").onclick = async () => {
      if (deferredPrompt) {
        deferredPrompt.prompt();
        const { outcome } = await deferredPrompt.userChoice;
        if (outcome === 'accepted') {
          console.log('PWA installed successfully');
          // Redirect to app immediately after installation
          document.getElementById("welcome").style.display = "none";
          document.getElementById("appFrame").style.display = "block";
          document.getElementById("appIframe").src = SCRIPT_URL;
        }
        deferredPrompt = null;
      }
    };

    if (!('onbeforeinstallprompt' in window)) {
      document.getElementById("installHelp").style.display = "block";
      document.getElementById("installHelp").innerHTML = `
        <strong>üì± To install this app:</strong><br>
        1. Open browser menu (‚ãÆ)<br>
        2. Tap "Add to Home Screen"<br>
        3. Launch from home screen for best camera performance
      `;
    }
  });

  // Enhanced service worker for camera support
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('/sw.js')
      .then(registration => {
        console.log('SW registered: ', registration);
      })
      .catch(err => console.error("SW Error", err));
  }

  // Camera permission helper
  window.requestCameraPermission = async () => {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ video: true });
      stream.getTracks().forEach(track => track.stop());
      return true;
    } catch (error) {
      console.error('Camera permission denied:', error);
      return false;
    }
  };
</script>
</body>
</html>
